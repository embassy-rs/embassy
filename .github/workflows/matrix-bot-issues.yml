name: Matrix bot for issues
on:
  issues:
    types: [opened]

jobs:
  notify:
    if: github.repository == 'embassy-rs/embassy'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: send message
        uses: actions/github-script@v8
        with:
          script: |
            const action = context.payload.action;
            const title = context.payload.issue.title;
            const issueBody = context.payload.issue.body;
            const url = context.payload.issue.html_url;

            // Determine message prefix
            let prefix;
            let roomId;
            if (action === 'opened' && (title + ' ' + issueBody).toLowerCase().includes('esp32')) {
              // Nag danielb
              prefix = 'New Issue';
              roomId = '!oENPKPHeKwiPfIVHER:matrix.org';
            } else {
              return; // Unknown action, skip
            }

            // HTML escape the title
            const titleEscaped = title
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;');

            const body = `${prefix}: ${title} - ${url}`;
            const formattedBody = `${prefix}: <a href="${url}">${titleEscaped}</a>`;

            const accessToken = process.env.MATRIX_ACCESS_TOKEN;

            const response = await fetch(
              `https://matrix.org/_matrix/client/r0/rooms/${roomId}/send/m.room.message`,
              {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                  msgtype: 'm.text',
                  format: 'org.matrix.custom.html',
                  body: body,
                  formatted_body: formattedBody
                })
              }
            );

            if (!response.ok) {
              throw new Error(`Matrix API request failed: ${response.status} ${response.statusText}`);
            }
        env:
          MATRIX_ACCESS_TOKEN: ${{ secrets.MATRIX_ACCESS_TOKEN }}
